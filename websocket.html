<!DOCTYPE html>
<html>
<head>
    <title>Test WebSocket (Raw Mode)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; }
        .box { margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
        #logs { height: 300px; overflow-y: scroll; background: #222; color: #0f0; padding: 10px; border: 1px solid #999; }
        input { padding: 5px; }
    </style>
</head>
<body>

    <h2>‚ö°Ô∏è Test WebSocket (Raw Stomp Client)</h2>
    <p>Ch·∫ø ƒë·ªô n√†y m√¥ ph·ªèng y h·ªát Postman: K·∫øt n·ªëi th·∫≥ng v√†o <b>/ws/websocket</b></p>

    <div class="box">
        <label>1. Nh·∫≠p JWT Token:</label><br>
        <input type="text" id="jwtToken" style="width: 100%;" placeholder="eyJhbGci...">
    </div>

    <div class="box">
        <label>2. K·∫øt n·ªëi:</label>
        <button onclick="connect()">CONNECT</button>
        <button onclick="disconnect()" disabled id="btnDisconnect">DISCONNECT</button>
        <span id="status" style="font-weight:bold; color:red">üî¥ Disconnected</span>
    </div>

    <div class="box">
        <label>3. Chat (Room ID):</label><br>
        Room ID: <input type="text" id="roomId" value="room1"><br>
        Message: <input type="text" id="message" value="Hello from Browser"><br>
        <button onclick="sendMessage()">SEND</button>
    </div>

    <div id="logs"></div>

    <script>
        var stompClient = null;

        function log(msg) {
            var logs = document.getElementById('logs');
            var p = document.createElement('div');
            p.innerHTML = msg;
            logs.prepend(p);
        }

        function connect() {
            var token = document.getElementById('jwtToken').value.trim();
            if (!token) { alert("Thi·∫øu Token!"); return; }

            // üî• QUAN TR·ªåNG: D√πng ws:// v√† ƒë∆∞·ªùng d·∫´n /ws/websocket + token query param
            // ƒê√¢y l√† c√°ch Postman ƒëang ch·∫°y
            var url = 'ws://localhost:8080/ws/websocket?token=' + token;
            
            log("Connecting to: " + url);

            // T·∫°o Stomp Client tr·ª±c ti·∫øp tr√™n n·ªÅn WebSocket
            stompClient = Stomp.client(url);

            // T·∫Øt debug log r√°c c·ªßa Stomp n·∫øu mu·ªën
            // stompClient.debug = null; 

            stompClient.connect({}, function (frame) {
                document.getElementById('status').innerHTML = "üü¢ Connected";
                document.getElementById('status').style.color = "green";
                document.getElementById('btnDisconnect').disabled = false;
                log("‚úÖ <b>Connected!</b>");

                // Subscribe v√†o Topic ƒë·ªÉ nh·∫≠n tin nh·∫Øn
                var roomId = document.getElementById('roomId').value;
                // Ph·∫£i th√™m ch·ªØ "chat" v√†o cho kh·ªõp v·ªõi bi·∫øn destSlash trong Java
                var subUrl = '/topic/chat/' + roomId;
                
                log("Subscribing to: " + subUrl);
                stompClient.subscribe(subUrl, function (messageOutput) {
                    log("üì© <b>Nh·∫≠n tin:</b> " + messageOutput.body);
                });

            }, function (error) {
                console.error(error);
                log("<span style='color:red'>‚ùå L·ªói k·∫øt n·ªëi: " + error + "</span>");
                log("<i>G·ª£i √Ω: Ki·ªÉm tra l·∫°i Token ho·∫∑c xem log IntelliJ</i>");
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            document.getElementById('status').innerHTML = "üî¥ Disconnected";
            document.getElementById('status').style.color = "red";
            document.getElementById('btnDisconnect').disabled = true;
            log("Disconnected");
        }

        function sendMessage() {
            var roomId = document.getElementById('roomId').value;
            var content = document.getElementById('message').value;

            if (!stompClient) { alert("Ch∆∞a k·∫øt n·ªëi!"); return; }

            // G·ª≠i tin nh·∫Øn
            var sendUrl = "/app/chat/" + roomId + "/send";
            var payload = JSON.stringify({'content': content});

            stompClient.send(sendUrl, {}, payload);
            log("üì§ <b>G·ª≠i:</b> " + payload);
        }
    </script>
</body>
</html>