- name: Build with Gradle
  run: |
    chmod +x gradlew
    ./gradlew clean bootJar -x test

- name: Verify build outputs
  run: |
    echo "Workspace: $(pwd)"
    echo "Top-level files:"
    ls -la || true

    echo "build/libs contents:"
    ls -la build/libs || true

    echo "Dockerfile present?"
    ls -la Dockerfile || true

    if ! ls build/libs/*.jar 1> /dev/null 2>&1; then
      echo "::error::No jar found in build/libs. Check Gradle tasks or build logs."
      exit 1
    fi

- name: Copy app to server
  uses: appleboy/scp-action@v0.1.4
  with:
    host: ${{ secrets.HOST }}
    username: ${{ secrets.USERNAME }}
    key: ${{ secrets.SSH_KEY }}
    source: |
      build/libs/*.jar
      Dockerfile
    target: /home/${{ secrets.USERNAME }}/deploy
    strip_components: 0

- name: Deploy on server
  uses: appleboy/ssh-action@v0.1.8
  with:
    host: ${{ secrets.HOST }}
    username: ${{ secrets.USERNAME }}
    key: ${{ secrets.SSH_KEY }}
    script: |
      cd /home/${{ secrets.USERNAME }}/deploy

      echo "Stop old container (if exists)"
      docker stop my-website || true
      docker rm my-website || true

      echo "Build Docker image"
      docker build -t myapp:latest .

      echo "Run new container"
      docker run -d --name my-website -p 80:8080 myapp:latest

      echo "Deploy done!"
